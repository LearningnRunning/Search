# ìŒì‹ì  ê²€ìƒ‰ ì‹œìŠ¤í…œ - Makefile (uv ê¸°ë°˜)

.PHONY: help install run test lint format clean check-python setup prepare-hf generate-embeddings verify-embeddings

# ê¸°ë³¸ íƒ€ê²Ÿ
help:
	@echo "ğŸ½ï¸ ìŒì‹ì  ê²€ìƒ‰ ì‹œìŠ¤í…œ - ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@echo "  install     - uvë¡œ ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  run         - Gradio ì•± ì‹¤í–‰"
	@echo "  test        - í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  lint        - ì½”ë“œ ë¦°íŒ…"
	@echo "  format      - ì½”ë“œ í¬ë§·íŒ…"
	@echo "  clean       - ìºì‹œ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬"
	@echo "  check-python - Python ë²„ì „ í™•ì¸"
	@echo "  setup       - ê°œë°œ í™˜ê²½ ì „ì²´ ì„¤ì •"
	@echo "  prepare-hf  - Hugging Face Spaces ë°°í¬ ì¤€ë¹„"
	@echo ""
	@echo "ğŸ”¢ ë²¡í„° ê´€ë¦¬:"
	@echo "  generate-embeddings - ìŒì‹ì  ì´ë¦„ ë²¡í„° ìƒì„±"
	@echo "  verify-embeddings   - ìƒì„±ëœ ë²¡í„° íŒŒì¼ ê²€ì¦"
	@echo ""

# Python ë²„ì „ í™•ì¸
check-python:
	@echo "ğŸ Python ë²„ì „ í™•ì¸ ì¤‘..."
	@python --version
	@python -c "import sys; assert sys.version_info >= (3, 11), f'Python 3.11+ í•„ìš”, í˜„ì¬: {sys.version}'"
	@echo "âœ… Python ë²„ì „ í™•ì¸ ì™„ë£Œ"

# uvë¡œ ì˜ì¡´ì„± ì„¤ì¹˜
install: check-python
	@echo "ğŸ“¦ uvë¡œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	uv sync
	@echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

# ê°œë°œ ì˜ì¡´ì„± í¬í•¨ ì„¤ì¹˜
install-dev: check-python
	@echo "ğŸ“¦ ê°œë°œ ì˜ì¡´ì„± í¬í•¨ ì„¤ì¹˜ ì¤‘..."
	uv sync --dev
	@echo "âœ… ê°œë°œ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

# Gradio ì•± ì‹¤í–‰
run: install
	@echo "ğŸš€ Gradio ì•± ì‹¤í–‰ ì¤‘..."
	uv run gradio app.py

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test: install-dev
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	uv run pytest tests/ -v

# ì½”ë“œ ë¦°íŒ…
lint: install-dev
	@echo "ğŸ” ì½”ë“œ ë¦°íŒ… ì¤‘..."
	uv run ruff check src/ tests/

# ì½”ë“œ í¬ë§·íŒ…
format: install-dev
	@echo "âœ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘..."
	uv run ruff format src/ tests/

# íƒ€ì… ì²´í¬
type-check: install-dev
	@echo "ğŸ” íƒ€ì… ì²´í¬ ì¤‘..."
	uv run mypy src/

# ëª¨ë“  ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
check: format lint type-check
	@echo "âœ… ëª¨ë“  ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"

# ìºì‹œ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
clean:
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name "*.pyd" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

# ê°œë°œ í™˜ê²½ ì „ì²´ ì„¤ì •
setup: clean install-dev
	@echo "ğŸ‰ ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ!"
	@echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”:"
	@echo "  make run"

# ìŒì‹ì  ì´ë¦„ ë²¡í„° ìƒì„±
generate-embeddings: install-dev
	@echo "ğŸ”¢ ìŒì‹ì  ì´ë¦„ ë²¡í„° ìƒì„± ì¤‘..."
	uv run python scripts/generate_embeddings.py
	@echo "âœ… ë²¡í„° ìƒì„± ì™„ë£Œ!"

# ë²¡í„° íŒŒì¼ ê²€ì¦
verify-embeddings: install-dev
	@echo "ğŸ” ë²¡í„° íŒŒì¼ ê²€ì¦ ì¤‘..."
	uv run python scripts/generate_embeddings.py --verify
	@echo "âœ… ë²¡í„° ê²€ì¦ ì™„ë£Œ!"

# Hugging Face Spaces ë°°í¬ ì¤€ë¹„
prepare-hf:
	@echo "ğŸš€ Hugging Face Spaces ë°°í¬ ì¤€ë¹„ ì¤‘..."
	@echo "ë‹¤ìŒ íŒŒì¼ë“¤ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤:"
	@echo "  - app.py (í†µí•© ì•±)"
	@echo "  - pyproject.toml (ì˜ì¡´ì„±)"
	@echo "  - README_HF.md (Space ì„¤ëª…)"
	@echo "  - data/diner_infos.json (ìŒì‹ì  ë°ì´í„°)"
	@echo "  - data/embeddings/ (ë²¡í„° íŒŒì¼ë“¤)"
	@echo "  - src/ (ì†ŒìŠ¤ ì½”ë“œ)"
	@echo ""
	@echo "Hugging Face Spacesì— ì—…ë¡œë“œí•  íŒŒì¼ë“¤:"
	@echo "1. app.py"
	@echo "2. pyproject.toml"
	@echo "3. README_HF.md â†’ README.mdë¡œ ì´ë¦„ ë³€ê²½"
	@echo "4. data/diner_infos.json"
	@echo "5. data/embeddings/ í´ë” ì „ì²´"
	@echo "6. src/ í´ë” ì „ì²´"

# íŒ¨í‚¤ì§€ ê´€ë¦¬
add:
	@echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì¶”ê°€ (ì‚¬ìš©ë²•: make add PKG=package_name)"
	@if [ -z "$(PKG)" ]; then echo "âŒ PKG ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ì˜ˆ: make add PKG=requests"; exit 1; fi
	uv add $(PKG)

add-dev:
	@echo "ğŸ“¦ ê°œë°œ íŒ¨í‚¤ì§€ ì¶”ê°€ (ì‚¬ìš©ë²•: make add-dev PKG=package_name)"
	@if [ -z "$(PKG)" ]; then echo "âŒ PKG ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ì˜ˆ: make add-dev PKG=pytest"; exit 1; fi
	uv add --dev $(PKG)

remove:
	@echo "ğŸ—‘ï¸ íŒ¨í‚¤ì§€ ì œê±° (ì‚¬ìš©ë²•: make remove PKG=package_name)"
	@if [ -z "$(PKG)" ]; then echo "âŒ PKG ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ì˜ˆ: make remove PKG=requests"; exit 1; fi
	uv remove $(PKG)

# ì˜ì¡´ì„± íŠ¸ë¦¬ í‘œì‹œ
tree:
	@echo "ğŸŒ³ ì˜ì¡´ì„± íŠ¸ë¦¬:"
	uv tree

# requirements.txt ìƒì„± (Hugging Face Spacesìš©)
export-requirements:
	@echo "ğŸ“„ requirements.txt ìƒì„± ì¤‘..."
	uv export --format requirements.txt > requirements.txt
	@echo "âœ… requirements.txt ìƒì„± ì™„ë£Œ" 